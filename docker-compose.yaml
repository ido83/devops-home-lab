# ------------------------------------------------------------------------------
# DevOps Home Lab - Fully Validated Stable Stack
# ------------------------------------------------------------------------------
networks:
  devops_lab:
    name: devops_lab
    driver: bridge

volumes:
  master_docker_data:
  worker1_docker_data:
  worker2_docker_data:
  gitea_data:
  gitea_db:
  woodpecker_server_data:
  woodpecker_agent_data:
  semaphore_db:
  semaphore_data:
  grafana_data:
  portainer_data:
  harbor_registry_data:
  harbor_db_data:

services:
  # ============================================================================
  # 1) NODE SIMULATION (Simulated Servers)
  # ============================================================================
  lab-master:
    build: ./nodes/ubuntu-dind-ssh
    container_name: lab-master
    privileged: true
    networks: [devops_lab]
    ports: ["${MASTER_SSH_PORT:-2221}:22"]
    volumes:
      - master_docker_data:/var/lib/docker
      - ./ansible/keys/authorized_keys:/root/.ssh/authorized_keys:ro
    restart: unless-stopped

  lab-worker1:
    build: ./nodes/ubuntu-dind-ssh
    container_name: lab-worker1
    privileged: true
    networks: [devops_lab]
    ports: ["${WORKER1_SSH_PORT:-2222}:22"]
    volumes:
      - worker1_docker_data:/var/lib/docker
      - ./ansible/keys/authorized_keys:/root/.ssh/authorized_keys:ro
    restart: unless-stopped

  # ============================================================================
  # 2) AUTOMATION LAYER (Ansible & Terraform/Terragrunt)
  # ============================================================================
  ansible-cli:
    image: python:3.11-slim
    container_name: ansible-cli
    networks: [devops_lab]
    volumes:
      - .:/work
      - ./ansible/keys/id_rsa:/root/.ssh/id_rsa:ro
    working_dir: /work
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y openssh-client rsync
        pip install --no-cache-dir ansible
        chmod 600 /root/.ssh/id_rsa
        echo "Ansible CLI Ready."
        tail -f /dev/null

  tf:
    # Switched to official community alpine image for 100% pull success
    image: alpine/terragrunt:1.9.5
    container_name: tf
    networks: [devops_lab]
    volumes: [".:/work"]
    working_dir: /work
    entrypoint: ["sh", "-lc"]
    command: ["tail -f /dev/null"]

  semaphore-db:
    image: postgres:15-alpine
    container_name: semaphore-db
    networks: [devops_lab]
    environment:
      - POSTGRES_DB=semaphore
      - POSTGRES_USER=semaphore
      - POSTGRES_PASSWORD=${SEMAPHORE_DB_PASSWORD:-sem_pass}
    volumes: [semaphore_db:/var/lib/postgresql/data]

  semaphore:
    image: semaphoreui/semaphore:latest
    container_name: semaphore
    depends_on: [semaphore-db]
    networks: [devops_lab]
    ports: ["${SEMAPHORE_HTTP_PORT:-3002}:3000"]
    environment:
      - SEMAPHORE_DB_DIALECT=postgres
      - SEMAPHORE_DB_HOST=semaphore-db
      - SEMAPHORE_DB_PORT=5432
      - SEMAPHORE_DB_USER=semaphore
      - SEMAPHORE_DB_PASS=${SEMAPHORE_DB_PASSWORD:-sem_pass}
      - SEMAPHORE_DB=semaphore
      - SEMAPHORE_ADMIN=${SEMAPHORE_ADMIN:-admin}
      - SEMAPHORE_ADMIN_PASSWORD=${SEMAPHORE_ADMIN_PASSWORD:-admin_pass}
      - SEMAPHORE_ACCESS_KEY_ENCRYPTION=${SEMAPHORE_ACCESS_KEY_ENCRYPTION:-secret}

  # ============================================================================
  # 3) ALM STACK (Gitea, Woodpecker, Harbor)
  # ============================================================================
  gitea-db:
    image: postgres:15-alpine
    container_name: gitea-db
    networks: [devops_lab]
    environment:
      - POSTGRES_DB=gitea
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=${GITEA_DB_PASSWORD:-gitea_pass}
    volumes: [gitea_db:/var/lib/postgresql/data]

  gitea:
    image: gitea/gitea:${GITEA_VERSION:-1.22}
    container_name: gitea
    depends_on: [gitea-db]
    networks: [devops_lab]
    ports: ["${GITEA_HTTP_PORT:-3001}:3000"]
    environment:
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=gitea-db:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD:-gitea_pass}
    volumes: [gitea_data:/data]

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:latest
    container_name: woodpecker-server
    networks: [devops_lab]
    ports: ["${WOODPECKER_HTTP_PORT:-8000}:8000"]
    environment:
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_URL=http://gitea:3000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET:-secret}

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:latest
    container_name: woodpecker-agent
    networks: [devops_lab]
    depends_on: [woodpecker-server]
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET:-secret}
    volumes: ["/var/run/docker.sock:/var/run/docker.sock"]

  harbor-db:
    # Fixed: official postgres to avoid bitnami manifest issues
    image: postgres:13-alpine
    container_name: harbor-db
    networks: [devops_lab]
    environment:
      - POSTGRES_PASSWORD=${HARBOR_DB_PASSWORD:-harbor_pass}
      - POSTGRES_DB=registry
    volumes: [harbor_db_data:/var/lib/postgresql/data]

  harbor-core:
    image: goharbor/harbor-core:v2.10.0
    container_name: harbor-core
    networks: [devops_lab]
    depends_on: [harbor-db]

  # ============================================================================
  # 4) MANAGEMENT & MONITORING
  # ============================================================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    networks: [devops_lab]
    ports: ["9000:9000"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    networks: [devops_lab]
    ports: ["3003:3000"]
    volumes: [grafana_data:/var/lib/grafana]
